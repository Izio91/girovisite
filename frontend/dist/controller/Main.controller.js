sap.ui.define(["./BaseController","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/Fragment","sap/m/p13n/Engine","sap/m/p13n/SelectionController","sap/m/p13n/SortController","sap/m/p13n/GroupController","sap/m/p13n/FilterController","sap/m/p13n/MetadataHelper","sap/ui/model/Sorter","sap/m/ColumnListItem","sap/m/Button","sap/m/Text","sap/m/ObjectIdentifier","sap/ui/core/library","sap/m/table/ColumnWidthController","sap/ui/model/Filter","sap/ui/model/FilterOperator","frontend/utils/formatter","sap/ui/core/SeparatorItem"],(e,t,n,r,i,o,a,s,l,c,u,d,g,h,p,m,f,v,y,k,w)=>{"use strict";var S;var C;var V;return e.extend("frontend.controller.Main",{formatter:k,onInit(){S=jQuery.sap.getModulePath(this.getOwnerComponent().getMetadata().getManifest()["sap.app"].id);C=this.getOwnerComponent().getModel("i18n").getResourceBundle();V={vpid:0,vctext:1,SortField:2,driver1:3,termCode:4,datfr:5,datto:6,kunnr:7,KunnrCustomerName:8,datab:9,datbi:10,kunwe:11,KunweCustomerName:12,StreetName:13,PostalCode:14,CustomerGroup:15,CustomerConditionGroup2:16,CityName:17,dtabwe:18,dtbiwe:19,turno:20,monday:21,tuesday:22,wednesday:23,thursday:24,friday:25,saturday:26,sunday:27,BusinessPartnerGrouping:28,vkorg:29,vtweg:30,spart:31,dtfine:32,active:33,loevm:34};var e=this.getOwnerComponent().getRouter();e.getRoute("main").attachPatternMatched(this._onObjectMatched,this)},_onObjectMatched:async function(){this.defineModelForCurrentPage();await this._fetchDrivers();this.onClearFilterBar();await this.onGoPress();this._registerForP13n()},_registerForP13n:function(){const e=this.byId("mainTable");this.oMetadataHelper=new c([{key:"vpid_col",label:C.getText("vpid"),path:"vpid"},{key:"vctext_col",label:C.getText("vctext"),path:"vctext"},{key:"werks_col",label:C.getText("werks"),path:"werks"},{key:"vkorg_col",label:C.getText("vkorg"),path:"vkorg"},{key:"vtweg_col",label:C.getText("vtweg"),path:"vtweg"},{key:"spart_col",label:C.getText("spart"),path:"spart"},{key:"driver1_col",label:C.getText("driver1"),path:"driver1"},{key:"termCode_col",label:C.getText("termCode"),path:"termCode"},{key:"datfr_col",label:C.getText("datfr"),path:"datfr"},{key:"datto_col",label:C.getText("datto"),path:"datto"},{key:"kunnr_col",label:C.getText("kunnr"),path:"kunnr"},{key:"inactive_col",label:C.getText("inactive"),path:"inactive"},{key:"active_col",label:C.getText("active"),path:"active"},{key:"loevm_col",label:C.getText("loevm"),path:"loevm"},{key:"erdat_col",label:C.getText("erdat"),path:"erdat"},{key:"erzet_col",label:C.getText("erzet"),path:"erzet"},{key:"ernam_col",label:C.getText("ernam"),path:"ernam"},{key:"aedat_col",label:C.getText("aedat"),path:"aedat"},{key:"aezet_col",label:C.getText("aezet"),path:"aezet"},{key:"aenam_col",label:C.getText("aenam"),path:"aenam"},{key:"kunwe_col",label:C.getText("kunwe"),path:"kunwe"},{key:"locked_col",label:C.getText("locked"),path:"locked",tooltip:"lockedBy"}]);i.getInstance().register(e,{helper:this.oMetadataHelper,controller:{Columns:new o({targetAggregation:"columns",control:e}),Sorter:new a({control:e}),Groups:new s({control:e}),ColumnWidth:new f({control:e}),Filter:new l({control:e})}});i.getInstance().attachStateChange(this.handleStateChange.bind(this))},openPersonalizationDialog:function(e){this._openPersoDialog(["Columns","Sorter","Groups","Filter"],e.getSource())},_openPersoDialog:function(e,t){var n=this.byId("mainTable");i.getInstance().show(n,e,{contentHeight:e.length>1?"50rem":"35rem",contentWidth:e.length>1?"45rem":"32rem",source:t||n})},_getKey:function(e){return e.data("p13nKey")},handleStateChange:async function(e){const t=this.byId("mainTable");const n=e.getParameter("state");if(!n){return}this.updateColumns(n);this.getView().getModel("masterModel").setProperty("/HeaderWithDetails",[]);await this._fetchData();const r=this.createGroups(n);const i=n.Columns.map(function(e){if(e.key==="vpid_col"){return new p({title:"{masterModel>"+this.oMetadataHelper.getProperty(e.key).path+"}"})}if(e.key==="locked_col"){return new g({press:this.onOpenUnlockMenuAction.bind(this),tooltip:"{i18n>lockedBy}: {masterModel>"+this.oMetadataHelper.getProperty(e.key).tooltip+"}",icon:"sap-icon://locked",type:"Transparent",visible:"{= ${masterModel>"+this.oMetadataHelper.getProperty(e.key).path+"} === true ? true : false }"})}return new h({text:"{masterModel>"+this.oMetadataHelper.getProperty(e.key).path+"}"})}.bind(this));t.bindItems({templateShareable:false,path:"masterModel>/HeaderWithDetails",sorter:r,template:new d({cells:i,type:"Navigation",highlight:"{= ${masterModel>locked} ? 'Information' : 'None' }",press:this.onListItemPress.bind(this)})})},createGroups:function(e){const t=[];var n={};if(e.Sorter){e.Sorter.forEach(({key:e,descending:t})=>n[e]=t)}e.Groups.forEach(function(e){t.push(new u(this.oMetadataHelper.getProperty(e.key).path,Object.keys(n).includes(e.key)?n[e.key]:false,true))}.bind(this));e.Groups.forEach(e=>{const t=this.byId("mainTable").getColumns().find(t=>t.data("p13nKey")===e.key);t.data("grouped",true)});return t},updateColumns:function(e){const t=this.byId("mainTable");t.getColumns().forEach((t,n)=>{t.setVisible(false);t.setWidth(e.ColumnWidth[this._getKey(t)]);t.setSortIndicator(m.SortOrder.None);t.data("grouped",false)});e.Columns.forEach((e,n)=>{const r=t.getColumns().find(t=>t.data("p13nKey")===e.key);r.setVisible(true);t.removeColumn(r);t.insertColumn(r,n)})},beforeOpenColumnMenu:function(e){const t=this.byId("menu");const n=e.getParameter("openBy");const r=t.getQuickActions()[0].getItems()[0];const i=t.getQuickActions()[1].getItems()[0];r.setKey(this._getKey(n));r.setLabel(n.getHeader().getText());r.setSortOrder(n.getSortIndicator());i.setKey(this._getKey(n));i.setLabel(n.getHeader().getText());i.setGrouped(n.data("grouped"))},onColumnHeaderItemPress:function(e){const t=e.getSource();let n="Columns";if(t.getIcon().indexOf("group")>=0){n="Groups"}else if(t.getIcon().indexOf("sort")>=0){n="Sorter"}else if(t.getIcon().indexOf("filter")>=0){n="Filter"}this._openPersoDialog([n])},onFilterInfoPress:function(e){this._openPersoDialog(["Filter"],e.getSource())},onSort:function(e){const t=e.getParameter("item");const n=this.byId("mainTable");const r=t.getKey();const o=t.getSortOrder();i.getInstance().retrieveState(n).then(function(e){e.Sorter.forEach(function(e){e.sorted=false});if(o!==m.SortOrder.None){e.Sorter.push({key:r,descending:o===m.SortOrder.Descending})}i.getInstance().applyState(n,e)})},onGroup:function(e){const t=e.getParameter("item");const n=this.byId("mainTable");const r=t.getKey();i.getInstance().retrieveState(n).then(function(e){e.Groups.forEach(function(e){e.grouped=false});if(t.getGrouped()){e.Groups.push({key:r})}i.getInstance().applyState(n,e)})},onColumnMove:function(e){const t=e.getParameter("draggedControl");const n=e.getParameter("droppedControl");if(t===n){return}const r=this.byId("mainTable");const o=e.getParameter("dropPosition");const a=r.indexOfColumn(t);const s=r.indexOfColumn(n);const l=s+(o=="Before"?0:1)+(a<s?-1:0);const c=this._getKey(t);i.getInstance().retrieveState(r).then(function(e){const t=e.Columns.find(function(e){return e.key===c})||{key:c};t.position=l;i.getInstance().applyState(r,{Columns:[t]})})},onColumnResize:function(e){const t=e.getParameter("column");const n=e.getParameter("width");const r=this.byId("mainTable");const o={};o[this._getKey(t)]=n;i.getInstance().applyState(r,{ColumnWidth:o})},onClearFilterPress:function(e){const t=this.byId("mainTable");i.getInstance().retrieveState(t).then(function(e){for(var n in e.Filter){e.Filter[n].map(e=>{e.filtered=false})}i.getInstance().applyState(t,e)})},onListItemPress:function(e){var t=e.getSource().getBindingContext("masterModel").getObject(),n=t.vpid,r=t.werks,i=t.vkorg,o=t.vtweg,a=t.spart;this.getOwnerComponent().getRouter().navTo("detail",{vpid:n,werks:r,vkorg:i,vtweg:o,spart:a})},defineModelForCurrentPage:function(){var e={HeaderWithDetails:[],valuehelps:{werks:[],vkorg:[],vtweg:[],driver:[],kunnr:[],kunwe:[]}};this.getView().setModel(new t(e),"masterModel")},onGoPress:function(){this._iSkip=0;this._iTop=2*this.getView().byId("mainTable").getGrowingThreshold();this.getView().getModel("masterModel").setProperty("/HeaderWithDetails",[]);this._fetchData()},_fetchDrivers:async function(){var e=this.getView().getModel("masterModel"),t=S+"/girovisiteService/getDriver()",r="/valuehelps/driver",i=this;try{sap.ui.core.BusyIndicator.show();var o=await this.executeRequest(t,"GET");e.setProperty(r,o.value[0].result);sap.ui.core.BusyIndicator.hide()}catch(e){n.error(C.getText("ErrorReadingDataFromBackend"),{title:"Error",details:e})}finally{sap.ui.core.BusyIndicator.hide()}},_fetchData:async function(){var e=this.getView().getModel("masterModel"),t=this;try{sap.ui.core.BusyIndicator.show();var r=await this._buildFilterQuery();var i=await this.executeRequest(r,"GET");var o=e.getProperty("/HeaderWithDetails")||[],a=o.concat(i.value);a=[...new Set(a)];e.setProperty("/HeaderWithDetails",a)}catch(e){n.error(C.getText("ErrorReadingDataFromBackend"),{title:"Error",details:e})}finally{sap.ui.core.BusyIndicator.hide()}},_buildFilterQuery:async function(){var e=S+"/girovisiteService/HeaderWithDetails?",t=[];t.push("$select=vpid,vctext,werks,vkorg,vtweg,spart,driver1,termCode,datfr,datto,active,loevm,inactive,erdat,erzet,ernam,aedat,aezet,aenam,locked,lockedBy,lockedAt,kunnr,kunwe");t.push("$top="+this._iTop);t.push("$skip="+this._iSkip);var[n,r]=await Promise.all([this._getFilters(),this._getSorters()]);if(r.length===0){r.push("vpid asc")}t.push("$orderby="+r.join(","));if(n.length>0){t.push("$filter="+n.join(" and "))}return e+t.join("&")},_getFilterAsString:function(e,t,n=false){if(e==="active"||e==="loevm"||e==="inactive"){if(t!==null&&t!=="default"){return`${e} eq '${t}'`}}else{if(t!==null&&t!==""){if(n){if(e==="datfr"){return`${e} ge '${t}'`}else if(e==="datto"){return`${e} le '${t}'`}else{return`${e} eq '${t}'`}}else{if(e==="driver1"){if(t.length>0){let n=t.map(t=>`${e} eq '${t}'`);return`(${n.join(" or ")})`}}else{return`${e} eq '${t}'`}}}}return null},_getFilters:function(){var e=[],t=this.getView(),n=this;function r(t,r,i){var o=n._getFilterAsString(t,r,i);if(o!==null){e.push(o)}}[["vpid","inputVpid",false],["werks","inputWerks",false],["vkorg","inputVkorg",false],["vtweg","inputVtweg",false],["driver1","multiComboDriver1",false],["kunnr","inputKunnr",false],["kunwe","inputKunwe",false],["datfr","datePickerDatfr",true],["datto","datePickerDatto",true],["active","comboBoxActive",false],["loevm","comboBoxLoevm",false],["inactive","comboBoxInactive",false],["spart","inputSpart",false],["termCode","inputTermCode",false],["erdat","datePickerErdat",true],["erzet","timePickerErzet",false],["ernam","inputErnam",false],["aedat","datePickerAedat",true],["aezet","timePickerAezet",false],["aenam","inputAenam",false]].forEach(([e,i,o])=>r(e,n.getControlValue(t.byId(i)),o));return i.getInstance().retrieveState(t.byId("mainTable")).then(t=>{Object.keys(t.Filter).forEach(e=>{var i=n.oMetadataHelper.getProperty(e).path;t.Filter[e].forEach(function(e){var t=["datePickerDatfr","datePickerDatto","datePickerErdat","datePickerAedat"].includes(i);r(i,e.values[0],t)})});return e})},_getSorters:function(){var e=this;return i.getInstance().retrieveState(this.getView().byId("mainTable")).then(t=>{var n=[];if(t.Sorter){t.Sorter.forEach(function(t){var r=t.descending?"desc":"asc";n.push(`${e.oMetadataHelper.getProperty(t.key).path} ${r}`)});t.Sorter.forEach(t=>{const n=e.byId("mainTable").getColumns().find(e=>e.data("p13nKey")===t.key);if(t.sorted!==false){n.setSortIndicator(t.descending?m.SortOrder.Descending:m.SortOrder.Ascending)}})}return n})},onClearFilterBar:function(){function e(e){this.getView().byId(e).setValue(null)}function t(e){this.getView().byId(e).setDateValue(null)}function n(e){this.getView().byId(e).setSelectedItem(null)}function r(e){this.getView().byId(e).setSelectedItem(null)}function i(e){this.getView().byId(e).setSelectedKey("default")}function o(e){this.getView().byId(e).setSelectedKeys(null)}e.call(this,"inputVpid");e.call(this,"inputWerks");e.call(this,"inputVkorg");e.call(this,"inputVtweg");o.call(this,"multiComboDriver1");e.call(this,"inputKunnr");e.call(this,"inputKunwe");t.call(this,"datePickerDatfr");t.call(this,"datePickerDatto");i.call(this,"comboBoxActive");i.call(this,"comboBoxLoevm");i.call(this,"comboBoxInactive");e.call(this,"inputSpart");e.call(this,"inputTermCode");t.call(this,"datePickerErdat");e.call(this,"timePickerErzet");e.call(this,"inputErnam");t.call(this,"datePickerAedat");e.call(this,"timePickerAezet");e.call(this,"inputAenam")},onTableGrowing:function(e){if(e.getParameters().reason==="Growing"){this._iSkip+=this._iTop;this._fetchData()}},onWerksVH:function(){var e=this.getView().getModel("masterModel"),t=S+"/girovisiteService/getWerks()",n="/valuehelps/werks",r="idWerksDialog_VH",i="frontend.view.fragments.WerksVH";this._onValueHelp(this,e,t,n,r,i)},onSearchWerks:function(e){this._onSearchValueHelp(e,this.getView(),["Plant","PlantName"],"idWerksDialog_VH")},onConfirmWerks:function(e){this._onConfirmValueHelp(e,"masterModel",this.getView(),"/Plant","inputWerks")},onVkorgVH:function(e){var t=this.getView().getModel("masterModel"),n=S+"/girovisiteService/getVkorg()",r="/valuehelps/vkorg",i="idVkorgDialog_VH",o="frontend.view.fragments.VkorgVH";this._onValueHelp(this,t,n,r,i,o)},onSearchVkorg:function(e){this._onSearchValueHelp(e,this.getView(),["SalesOrganization"],"idVkorgDialog_VH")},onConfirmVkorg:function(e){this._onConfirmValueHelp(e,"masterModel",this.getView(),"/SalesOrganization","inputVkorg")},onVtwegVH:function(e){var t=this.getView().getModel("masterModel"),n=S+"/girovisiteService/getVtweg()",r="/valuehelps/vtweg",i="idVtwegDialog_VH",o="frontend.view.fragments.VtwegVH";this._onValueHelp(this,t,n,r,i,o)},onSearchVtweg:function(e){this._onSearchValueHelp(e,this.getView(),["DistributionChannel"],"idVtwegDialog_VH")},onConfirmVtweg:function(e){this._onConfirmValueHelp(e,"masterModel",this.getView(),"/DistributionChannel","inputVtweg")},onDriverVH:function(e){var t=this.getView().getModel("masterModel"),n=S+"/girovisiteService/getDriver()",r="/valuehelps/driver",i="idDriverDialog_VH",o="frontend.view.fragments.DriverVH";this._onValueHelp(this,t,n,r,i,o)},onSearchDriver:function(e){this._onSearchValueHelp(e,this.getView(),["Customer","CustomerName"],"idDriverDialog_VH")},onKunnrVH:function(e){var t=this.getView().getModel("masterModel"),n=S+"/girovisiteService/getKunnr()",r="/valuehelps/kunnr",i="idKunnrDialog_VH",o="frontend.view.fragments.KunnrVH";this._onValueHelp(this,t,n,r,i,o)},onSearchKunnr:function(e){this._onSearchValueHelp(e,this.getView(),["Customer","CustomerName","StreetName","CityName","Region","PostalCode"],"idKunnrDialog_VH")},onConfirmKunnr:function(e){this._onConfirmValueHelp(e,"masterModel",this.getView(),"/Customer","inputKunnr")},onKunweVH:function(e){var t=this.getView().getModel("masterModel"),n=S+"/girovisiteService/getKunwe()",r="/valuehelps/kunwe",i="idKunweDialog_VH",o="frontend.view.fragments.KunweVH";this._onValueHelp(this,t,n,r,i,o)},onSearchKunwe:function(e){this._onSearchValueHelp(e,this.getView(),["Customer","CustomerName","StreetName","CityName","Region","PostalCode"],"idKunweDialog_VH")},onConfirmKunwe:function(e){this._onConfirmValueHelp(e,"masterModel",this.getView(),"/Customer","inputKunwe")},onCreateDetail:function(){this.getOwnerComponent().getRouter().navTo("create")},onOpenUnlockMenuAction:function(e){this.oContext=e.getSource().getBindingContext("masterModel");this.LockedBy=this.getView().getModel("masterModel").getProperty(this.oContext.getPath()+"/lockedBy");var t=e.getSource(),n=this.getView();if(!this._oLockMenuFragment){r.load({id:n.getId(),name:"frontend.view.fragments.LockMenu",controller:this}).then(function(e){n.addDependent(e);e.openBy(t);this._oLockMenuFragment=e}.bind(this))}else{this._oLockMenuFragment.openBy(t)}},onUnlockPress:function(){var e=this;n.warning(C.getText("unlockAlert",[this.LockedBy]),{actions:[n.Action.YES,n.Action.NO],emphasizedAction:n.Action.YES,onClose:function(t){if(t===n.Action.YES){e._confirmUnlock()}}})},_confirmUnlock:async function(){var e=this,t=S+"/girovisiteService/unlock",r=this.getView().getModel("masterModel").getProperty(this.oContext+"/vpid"),i={vpid:r.toString()};try{sap.ui.core.BusyIndicator.show();var o=await this.executeRequest(t,"POST",JSON.stringify(i));sap.ui.core.BusyIndicator.hide();n.information(C.getText("documentUnlocked"),{onClose:function(){e.onGoPress()}})}catch(t){sap.ui.core.BusyIndicator.hide();n.error(C.getText("ErrorReadingDataFromBackend"),{title:"Error",details:t,onClose:function(){e.onGoPress()}})}},onExportCSV:function(){var e=this;n.information(C.getText("ExportAlert"),{actions:[n.Action.YES,n.Action.NO],emphasizedAction:n.Action.YES,onClose:function(t){if(t===n.Action.YES){e._confirmExportCSV()}}})},_confirmExportCSV:async function(){var e=S+"/girovisiteService/getDataForCSV()?",t=[],r=await this._getFilters(),i=this;if(r.length>0){e=e+"filter="+r.join(" and ")}sap.ui.core.BusyIndicator.show();this.executeRequest(e,"GET").then(function(e){let t=e.value[0].result;sap.ui.core.BusyIndicator.hide();if(t.length>0){const e=t.map(e=>{let t={};Object.keys(V).forEach(n=>{t[n]=e[n]!==undefined?e[n]:null});return t});let n=i.getColumnsCSV(Object.keys(e[0]));const r=i.getCSV(n,e);const o=new Blob([r],{type:"text/csv;charset=utf-8;"});const a=document.createElement("a");const s=URL.createObjectURL(o);a.setAttribute("href",s);a.setAttribute("download",i.getFileName()+".csv");document.body.appendChild(a);a.click();document.body.removeChild(a)}else{n.information(C.getText("NoDataDueCurrentFilters"))}}).catch(function(e){let t="";sap.ui.core.BusyIndicator.hide();if(e.status===504){t=C.getText("ExportTimeoutError")}else{t=C.getText("ErrorReadingDataFromBackend")}console.log("Request failed:",e);n.error(t)})},getColumnsCSV:function(e){var t=[];e.forEach(e=>{t[V[e]]={label:C.getText(e),property:e}});return t},getCSV:function(e,t){const n=e.map(e=>e.label.replaceAll(","," ")).join(",");return[n,...t.map(e=>Object.values(e).map(e=>{if(typeof e==="string"){e=String(e).replaceAll(","," ")}return e}).join(","))].join("\r\n")},getFileName:function(){const e=new Date,t=e.getFullYear().toString(),n=String(e.getMonth()+1).padStart(2,0),r=String(e.getDate()).padStart(2,0),i=e.getHours().toString(),o=e.getMinutes().toString();return"Report_Giri_Visita_"+r+n+t}})});
//# sourceMappingURL=Main.controller.js.map